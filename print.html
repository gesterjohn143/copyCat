<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CopyCat - Print</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .shop-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            margin-bottom: 1rem;
            padding: 1rem;
            transition: border 0.2s;
        }
        .shop-card.selected {
            border: 2px solid #3498db;
        }
        .shop-card h4 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
        }
        .shop-card p {
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">CopyCat</a>
    </header>
    <div class="container">
        <h1>Print Your Documents</h1>
        <form id="printForm">
            <div>
                <label>Upload PDF or Image:</label>
                <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div>
                <label>Paper Size:</label>
                <select id="paperSize">
                    <option value="A4">A4</option>
                    <option value="Letter">Letter</option>
                    <option value="Legal">Legal</option>
                </select>
            </div>
            <div>
                <label>Print Type:</label>
                <select id="printType">
                    <option value="black-white">Black & White</option>
                    <option value="colored">Colored</option>
                </select>
            </div>
            <div>
                <label><input type="checkbox" id="doubleSided"> Double-sided</label>
                <label><input type="checkbox" id="stapled"> Stapled</label>
                <label><input type="checkbox" id="holePunched"> Hole-punched</label>
            </div>
            <div>
                <label>Copies:</label>
                <input type="number" id="copies" min="1" value="1">
            </div>
            <div>
                <h3>Select a Print Shop</h3>
                <div id="shopsList"></div>
            </div>
            <button type="submit" class="btn">Send to Shop</button>
        </form>
    </div>
    <footer>
        <p>&copy; 2025 CopyCat</p>
    </footer>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7zC2xkGU7VZu7iLnSBhv4n8EZnHrzJFw",
            authDomain: "copycat-d3561.firebaseapp.com",
            projectId: "copycat-d3561",
            storageBucket: "copycat-d3561.firebasestorage.app",
            messagingSenderId: "201940334771",
            appId: "1:201940334771:web:5d68712667c8a5526a58c6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        let selectedShop = null;
        let user = null;

        // Load shops from Firebase
        async function loadShops() {
            const shopsList = document.getElementById('shopsList');
            shopsList.innerHTML = "<p>Loading shops...</p>";
            const snapshot = await get(ref(db, 'shops'));
            shopsList.innerHTML = "";
            if (snapshot.exists()) {
                const shops = snapshot.val();
                Object.entries(shops).forEach(([shopId, shop]) => {
                    const card = document.createElement('div');
                    card.className = 'shop-card';
                    card.innerHTML = `
                        <h4>${shop.name}</h4>
                        <p>${shop.address}</p>
                        <p>Location: ${shop.lat}, ${shop.lng}</p>
                        <button type="button" class="btn">Select</button>
                    `;
                    card.querySelector('button').onclick = () => {
                        document.querySelectorAll('.shop-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedShop = { ...shop, shopId };
                    };
                    shopsList.appendChild(card);
                });
            } else {
                shopsList.innerHTML = "<p>No shops available.</p>";
            }
        }

        // Wait for user to be logged in
        onAuthStateChanged(auth, (u) => {
            if (!u) {
                alert("Please log in first.");
                window.location.href = "login.html";
            } else {
                user = u;
                loadShops();
            }
        });

        // Handle form submission
        document.getElementById('printForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedShop) {
                alert("Please select a shop.");
                return;
            }
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                alert("Please select a file.");
                return;
            }
            if (!user) {
                alert("You are not logged in!");
                return;
            }
            try {
                // Upload file to Firebase Storage
                const filePath = `printJobs/${user.uid}/${Date.now()}_${file.name}`;
                const fileRef = sRef(storage, filePath);
                await uploadBytes(fileRef, file);
                const fileURL = await getDownloadURL(fileRef);

                // Save print job to Realtime Database
                const jobRef = push(ref(db, "printJobs"));
                await set(jobRef, {
                    fileURL,
                    fileName: file.name,
                    userId: user.uid,
                    userEmail: user.email,
                    shopId: selectedShop.shopId,
                    shopName: selectedShop.name,
                    options: {
                        paperSize: document.getElementById('paperSize').value,
                        printType: document.getElementById('printType').value,
                        doubleSided: document.getElementById('doubleSided').checked,
                        stapled: document.getElementById('stapled').checked,
                        holePunched: document.getElementById('holePunched').checked,
                        copies: parseInt(document.getElementById('copies').value)
                    },
                    status: "Pending",
                    createdAt: Date.now()
                });
                alert("Your print job has been sent to " + selectedShop.name + "!");
                window.location.href = "orders.html";
            } catch (error) {
                alert("Upload failed: " + error.message);
                console.error(error);
            }
        });
    </script>
</body>
</html>